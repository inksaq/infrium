/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * Learn more about Gradle by exploring our samples at https://docs.gradle.org/8.0.1/samples
 */

//Shadowjar Work around for https://github.com/johnrengelman/shadow/issues/911
buildscript {
	ext {
		asmAsmVersion = "9.6" // https://gitlab.ow2.org/asm/asm/-/tags
	}
	configurations {
		classpath {
			resolutionStrategy {
				//in order to handle jackson's higher release version in shadow, this needs to be upgraded to latest.
				force(group: "org.ow2.asm", name: "asm", version: asmAsmVersion)
				force(group: "org.ow2.asm", name: "asm-commons", version: asmAsmVersion)
			}
		}
	}
}
plugins {
	id 'java'
	id 'com.github.johnrengelman.shadow' version '8.1.1'
	id 'maven-publish'
}

group 'com.infrium'
version '1.1'
repositories{
	mavenLocal()
	mavenCentral()

}

dependencies {
	compileOnly project(":api")
	compileOnly project(":core")
	compileOnly project(":lobby")
	compileOnly project(":proxy")
	compileOnly project(":hive" )
	compileOnly project(":game")
}



subprojects {
	apply plugin: 'java'
	apply plugin: 'com.github.johnrengelman.shadow'
	apply plugin: 'maven-publish'

	compileJava {
		sourceCompatibility = JavaVersion.VERSION_21
		targetCompatibility = JavaVersion.VERSION_21
		options.compilerArgs << '-nowarn'
	}
	java {
		toolchain.languageVersion.set(JavaLanguageVersion.of(21))
	}

	repositories {
		maven { url = "https://repo.papermc.io/repository/maven-public/" }
		maven { url = "https://repo.aikar.co/content/groups/aikar/" }
		maven { url = "https://repo.dmulloy2.net/repository/public/" }
		maven { url = "https://hub.spigotmc.org/nexus/content/repositories/snapshots/" }
		maven { url = "https://oss.sonatype.org/content/repositories/snapshots" }
		maven { url = "https://oss.sonatype.org/content/repositories/central" }
		maven { url = "https://repo.codemc.io/repository/maven-public/" }
	}
	dependencies {
		compileOnly 'org.projectlombok:lombok:1.18.30'
		annotationProcessor 'org.projectlombok:lombok:1.18.30'
		compileOnly 'org.mongodb:mongodb-driver-sync:4.4.0' // mongodb
		compileOnly 'io.lettuce:lettuce-core:6.1.5.RELEASE' // redis client
		compileOnly 'com.google.code.gson:gson:2.8.9' // google gson
		compileOnly group: 'org.apache.commons', name: 'commons-lang3', version: '3.12.0'
		// apache common lang 3
		compileOnly group: 'org.apache.commons', name: 'commons-text', version: '1.10.0'
		// apache common text
		compileOnly group: 'org.apache.commons', name: 'commons-collections4', version: '4.4'
		// apache common collections
		compileOnly 'org.hydev:HyLogger:2.1.0.378' // logging library
		compileOnly "co.aikar:acf-paper:0.5.1-SNAPSHOT" // command processor
		compileOnly "net.kyori:adventure-text-minimessage:4.17.0"
	}

	shadowJar {
		relocate 'com.mongodb', 'com.infrium.libs.com.mongodb'
		relocate 'io.lettuce', 'com.infrium.libs.io.lettuce'
		relocate 'org.bson', 'com.infrium.libs.org.bson'
//		relocate("de.tr7zw.changeme.nbtapi", "com.infrium.libs.de.trzw.changeme.nbtapi")
		//relocate 'org.slf4j', 'com.infrium.libs.org.slf4j'
		relocate 'org.apache.commons.lang3', 'com.infrium.libs.org.apache.commons.lang3'
		relocate 'org.apache.commons.text', 'com.infrium.libs.org.apache.commons.text'
		relocate 'org.apache.commons.collections4', 'com.infrium.libs.org.apache.commons.collections4'
//		 relocate 'com.google.gson', 'com.infrium.libs.com.google.gson'
		relocate 'reactor', 'com.infrium.libs.reactor'
		relocate 'org.reactivestreams', 'com.infrium.libs.org.reactivestreams'
		relocate 'io.netty', 'com.infrium.libs.io.netty'
		relocate 'co.aikar.commands', 'com.infrium.libs.acf'
		relocate 'co.aikar.locales', 'com.infrium.libs.locales'
		//minimize()
	}
    // The error occurs because we're publishing both the default jar and shadowJar with 'all' classifier

	jar {
		enabled = true  // Ensure the jar task is enabled
	}

//	publishing {
//		publications {
//			mavenJava(MavenPublication) {
//				from components.java
//				if (project.name != 'api') {
//					artifact shadowJar {
//						archiveClassifier = null  // Remove classifier to avoid conflicts
//					}
//				}
//			}
//		}
//		repositories {
//			maven {
//				name = "local"
//				url = uri("${project.rootDir}/repo")
//			}
//		}
//	}
	tasks.register('buildRelease') {
		dependsOn 'clean', 'build', 'shadowJar', 'candidateRelease'

		doLast {
			subprojects.each { subproject ->
				def propertiesFile = new File("${subproject.projectDir}/gradle.properties")
				if (propertiesFile.exists()) {
					Properties props = new Properties()
					propertiesFile.withInputStream { props.load(it) }

					def currentVersion = props.getProperty('version', '1.0.0')
					def versionParts = currentVersion.split('\\.')
					def newPatch = (versionParts[2] as int) + 1
					def newVersion = "${versionParts[0]}.${versionParts[1]}.${newPatch}"

					props.setProperty('version', newVersion)
					propertiesFile.withOutputStream { props.store(it, null) }

					println "Updated ${subproject.name} version from ${currentVersion} to ${newVersion}"
				}
			}
		}
	}
//	tasks.register('buildRelease', Copy) {
//
//		jar.dependsOn(core:candidateRelease)
//		jar.dependsOn(game:candidateRelease)
//		jar.dependsOn(lobby:candidateRelease)
//		jar.dependsOn(proxy:candidateRelease)
//	}

}